_attributes bit _click bit _nr drop \ to _attributes
/basis var data var fgc var bgc drop

z" sys/MxPlus_IBM_BIOS.ttf" #8 3 al_load_ttf_font
   constant ascii8x8.fnt
z" sys/MxPlus_IBM_VGA_8x16.ttf" #16 3 al_load_ttf_font
    constant ibm8x16.fnt

: sdims w v@ 2p>s ;
: over? mouse 2s>p abox inside? ;
: !font ascii8x8.fnt font ! ;
: data@ data @ dup 0; !font icount >z ;
: boxshadow  5 5 +at  sdims $00000040 color rectf  -5 -5 +at ;
: 2max rot max >r max r> ;

: click { _click aon } ;
: ?click hoveree ?dup 0; click ;
: unclick each> _click aoff me recurse ;

: exec data@ ?dup 0; zcount evaluate ;
: button-respond respond> 
    over? 0; 
    ALLEGRO_EVENT_MOUSE_BUTTON_DOWN happened? if ?click then
    ALLEGRO_EVENT_MOUSE_BUTTON_UP happened? if root unclick ['] exec try then
;

: ?expand x v@ w v@ 2+ 8. 8. 2+ parent @ { w v@ 2max w v! } ;
: ?nr _nr a? 0; next 0; 8. y @ h @ + 8. + next @ -> x v! ;
: ?layout _bolted a? 0; next @ if x @ w @ + 15. + y @ next @ -> x v! then ?nr ?expand ;

: ` [char] ` parse ;
: ser-widget ser>
    data @ ?dup if ." ` " icount type ." ` data! " then
    bgc @ h. ." bgc ! " ;
: 1w h @ 32. >= ?; data @ ?dup 0; count 8. * 32. + w ! drop ;
: ?freedata data @ ?dup if free drop then ;
: data! ?freedata dup icount+ allocate drop >r r@ iplace r> data ! 1w ;

: label-draw draw> white data@ stext ?layout ;
: (down) 2 2 +at sdims 2dup grey <d rectf grey rect -2 -2 +at ;
: (up) boxshadow sdims 2dup grey rectf white rect ;
: button-draw draw> _click a? if (down) else (up) then 16 10 +at data@ stext ;
: toolbox-draw draw> white sdims rectf black sdims rect sdims drop 8 black rectf 16 15 +at data@ text ;

create ox 0 , 0 ,
: toolbox-respond respond>
    over? 0;
    ALLEGRO_EVENT_MOUSE_BUTTON_DOWN happened? if 
        x v@ ox v!
    then
    ALLEGRO_EVENT_MOUSE_BUTTON_UP happened? if 
        x v@ ox v@ d= 0;
        first @ ?dup 0; toggle
    then
;

: panel-draw draw> sdims bgc @ color rectf ;

: textbox-draw draw>
    data @ 0;
    sdims bgc @ color rectf
    4 4 +at
    ibm8x16.fnt font !
    data@  w @ p>s 8 -  black mltext
;

object: *label 16. h ! _bolted aon label-draw ser-widget act> ?layout ;
object: *textbox 160. 160. w v! $fff8a0e0 bgc ! textbox-draw ser-widget $[ ." The rain " cr ." in Spain falls mainly on the plain." ]$ data! ;
object: *button 28. h !  _bolted aon button-draw ser-widget button-respond act> ?layout ;
object: *toolbox 128. 28. w v! toolbox-draw ser-widget toolbox-respond ;
object: *panel _bolted aon $00000040 bgc ! panel-draw act> 0 0 w v! ;

\ : [toolbox] *toolbox 0 32 at ;
\ : [panel] *panel 8 8 at ;

: break _nr aon ;

