require scripts/tilemap.vfx

obj animations

motif var tl var tlt var spd var ac var af /obj to /basis \ add animation capability to everything

\ - Runtime rendering
: ?+ac delta spd @ p/ ac +! ;
: keyframe { 0 me #children wrap me nth-child as children } ;
: animate spd ! tl ! draw> ac @ p>s tl @ keyframe ?+ac ;

\ - Tile keyframes
motif var ti
: draw-tile draw> ti @ tile+ ;
: ser-tile ser> ti ? ." ti !" ;
object: *tile 16. 16. w v! draw-tile ser-tile ; 

\ - Editor variables
0 value kf#
0 value editor
0 value anmc
\ 0 value tool \ object
\ 
\ obj modify-tool  
\ obj create-tool

\ - Editor actions
: anm anmc -> first @ ;
: hide-each each> hide on ;
: sel anm hide-each  anm nth-child -> hide off ;
: kf! 0 anm #children wrap to kf#  kf# sel ;
: +kf kf# + kf! ;
: tlpath z[ ." figures/timelines/" type ." .vfx" ]z zcount ;
\ : load anmc clear anmc { 0 parse tlpath included } ;
: +.tl count pad place s" .tl" pad append pad ;
: replace anmc -> first @ ?dup if animations push then anmc push 0 kf! ;
: edit bl word +.tl find if execute replace then ;

: (status)
    z[ kf# 1 + . ." / " anm #children . ]z white stext nr
\    z[ tool .name ]z white stext nr
;

\ - Editor components
: crosshairs 0 -64 +at 0 128 black line -64 64 +at 128 0 black line 64 0 +at ;
object: *preview 2. 2. sx 2! draw> crosshairs ;
object: *editor 2. 2. sx 2! draw> crosshairs ;
object: *status draw> (status) ;
object: *aed draw> -matte 0 winh 96 - at z[ ." AED" ]z white stext ;
object: *timeline ;
object: *keyframe ; 

\ - Test
include figures/timelines/test.vfx
: pspr-ser ser> tl @ .name spd p? ." animate" ;
object: *pspr pspr-ser draw> anm 0.25 animate ;

\ - Editor layout
apps {
    0 0 at *aed named aed {
        winw 0.16666 p* 200 at *preview named preview { 
            0 0 at *pspr named pspr { } 
        }
        winw 0.5 p* 200 at *editor named editor {
            0 0 at *generic named anmc { }
            -64 64 at *status { } 
        }
    }
}

: insert-after 2dup insert swap insert ;

\ - Editor controls (besides shed-provided actions)
editor { :noname
    respond>
    ui? ?;
    ALLEGRO_EVENT_KEY_CHAR happened? if
        the-char case
            [char] z of -1 +kf endof
            [char] x of 1 +kf endof
            [char] a of *keyframe kf# anm nth-child insert-after endof
        endcase
    then
    ALLEGRO_EVENT_KEY_DOWN happened? if
        the-key case
            <del> of anm #children 1 > if kf# anm nth-child remove then endof
        endcase
    then
    0 +kf 
; execute }


test.tl animations push
0.75e fdup fdup 1e backdrop 4f!
edit test
